<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }
      #download {
        display: inline-block;
        padding: 10px 20px;
        background-color: #4CAF50; /* Green */
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      #download:hover {
        background-color: #45a049;
      }
    </style>
    <script type='text/javascript'>
      
      /**
       * Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€å…ƒã®æ–‡å­—åˆ—ã«æˆ»ã—ã¾ã™ã€‚
       * (æ•´å½¢ã•ã‚ŒãŸJSONæ–‡å­—åˆ—ã‚’å¾©å…ƒ)
       */
      function decodeBase64(s) {
        // atob() ã§Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
        var decoded = atob(s);
        var len = decoded.length;
        var bytes = new Uint8Array(len);
        
        // æ–‡å­—åˆ—ã‚’ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›
        for (var i = 0; i < len; i++) {
          bytes[i] = decoded.charCodeAt(i);
        }
        // ãƒã‚¤ãƒˆé…åˆ—ã‚’UTF-8ã§æ–‡å­—åˆ—ã«å¤‰æ›
        // (TextDecoderã¯ä¸€éƒ¨å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§éå¯¾å¿œã®å ´åˆãŒã‚ã‚‹ãŒã€ç¾ä»£ã®ç’°å¢ƒã§ã¯æ¨™æº–çš„)
        return new TextDecoder("utf-8").decode(bytes);
      }
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è¨­å®šã‚’åˆæœŸåŒ–
      window.onload = function() {
        handleDownload();
      }

      function handleDownload() {
        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’GASã‹ã‚‰å–å¾—
        var encodedContent = '<?!= getEncodedData(); ?>'; 
        
        // Base64æ–‡å­—åˆ—ãŒç©ºã‹ã€ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ '{}' ã®Base64 ('e30=') ã®å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
        if (encodedContent === '' || encodedContent.trim() === 'e30=') {
            alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            document.getElementById("download").style.backgroundColor = 'gray';
            document.getElementById("download").innerText = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            document.getElementById("download").onclick = function(){ return false; };
            return;
        }

        // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã€æ”¹è¡Œãƒ»ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’å«ã‚€æ•´å½¢æ¸ˆã¿JSONæ–‡å­—åˆ—ã«æˆ»ã™
        var content = decodeBase64(encodedContent);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨URLç”Ÿæˆ (Blobã‚’ä½œæˆ)
        var blob = new Blob([ content ], { "type" : "application/json;charset=utf-8"});
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯è¦ç´ ã«URLã‚’ã‚»ãƒƒãƒˆ
        document.getElementById("download").href = window.URL.createObjectURL(blob);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’GASã‹ã‚‰å—ã‘å–ã£ã¦è¨­å®š
        document.getElementById("download").download = '<?!= fileName ?>';
      }
    </script>
  </head>
  <body>
    <p style="text-align: center;">ğŸ‘‡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
    <a id="download" href="#" download="data.json">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a> 
  </body>
</html>