FROM python:3.10-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Install minimal OS-level deps (libpq for psycopg2-binary is optional but safe)
# Include postgresql-client so `pg_isready` is available for health/wait loops.
RUN apt-get update \
     && apt-get install -y --no-install-recommends \
         build-essential \
         libpq-dev \
         postgresql-client \
         curl \
     && rm -rf /var/lib/apt/lists/*

# Copy requirements (Playwright excluded) and install
COPY backend/requirements.nopw.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# Copy backend sources
COPY backend/ /app

# Ensure entrypoint is executable
RUN if [ -f /app/entrypoint.sh ]; then chmod +x /app/entrypoint.sh; fi

EXPOSE 8000
ENTRYPOINT ["/app/entrypoint.sh"]
